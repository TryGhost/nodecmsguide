---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { toSlug } from '../../../scripts/util.js';
import fetchArchive from '../../../scripts/fetch-archive.js';
import { extractRelevantProjectData } from '../../../scripts/project-data.js';
import { pickBy } from 'lodash-es';

const SITE_URL = 'https://nodecms.guide';

export async function getStaticPaths() {
  const projectEntries = await getCollection('projects');
  return projectEntries.map((entry) => ({
    params: { slug: toSlug(entry.data.title) },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

// Map project data
const projectDetails = [{
  title: entry.data.title,
  slug: toSlug(entry.data.title),
  repo: entry.data.repo,
  homepage: entry.data.homepage,
  openSource: entry.data.opensource.toLowerCase() === 'yes',
  generators: entry.data.supportedgenerators,
  type: entry.data.typeofcms,
  description: entry.data.description,
  images: entry.data.images,
  starterTemplateRepo: entry.data.startertemplaterepo,
}];

// Fetch GitHub data
let projectData: Record<string, any> = {};
try {
  const projectDataRaw = await fetchArchive(projectDetails);
  projectData = extractRelevantProjectData(projectDataRaw);
} catch (error) {
  console.warn('Failed to fetch GitHub data:', error);
}

const slug = toSlug(entry.data.title);
const data = projectData[slug] || {};
const project = pickBy({ ...projectDetails[0], ...data }, (val) => val !== undefined && val !== null);

const shareUrl = `${SITE_URL}/projects/${slug}`;
const shareText = `Check out ${entry.data.title}, a Node.js content management system: `;

function formatNumber(num: number | undefined): string {
  if (typeof num !== 'number') return 'N/A';
  return num.toLocaleString();
}
---

<BaseLayout title={entry.data.title} shareUrl={shareUrl} shareText={shareText}>
  <Header shareUrl={shareUrl} shareText={shareText} />
  <div class="main">
    <div class="sheet">
      {entry.data.opensource.toLowerCase() === 'yes' && <div class="tag">open source</div>}
      <h1>{entry.data.title}</h1>

      <div class="links">
        {entry.data.homepage && (
          <div class="detail-link">
            <a href={entry.data.homepage} target="_blank" rel="noopener noreferrer">
              <svg class="icon" viewBox="0 0 20 20" width="16" height="16" aria-hidden="true">
                <path d="M18.121,9.88l-7.832-7.836c-0.155-0.158-0.428-0.155-0.584,0L1.842,9.913c-0.262,0.263-0.073,0.705,0.292,0.705h2.069v7.042c0,0.227,0.187,0.414,0.414,0.414h3.725c0.228,0,0.414-0.188,0.414-0.414v-3.313h2.483v3.313c0,0.227,0.187,0.414,0.413,0.414h3.726c0.229,0,0.414-0.188,0.414-0.414v-7.042h2.068C18.189,10.585,18.384,10.144,18.121,9.88 M14.963,17.245h-2.896v-3.313c0-0.229-0.186-0.415-0.414-0.415H8.342c-0.228,0-0.414,0.187-0.414,0.415v3.313H5.032v-6.628h9.931V17.245z M3.133,9.79l6.864-6.868l6.867,6.868H3.133z" fill="currentColor"></path>
              </svg>
              {entry.data.homepage}
            </a>
          </div>
        )}
        {entry.data.repo && (
          <div class="detail-link">
            <a href={`https://github.com/${entry.data.repo}`} target="_blank" rel="noopener noreferrer">
              <svg class="icon" viewBox="0 0 20 20" width="16" height="16" aria-hidden="true">
                <path d="M13.18,11.309c-0.718,0-1.3,0.807-1.3,1.799c0,0.994,0.582,1.801,1.3,1.801s1.3-0.807,1.3-1.801C14.479,12.116,13.898,11.309,13.18,11.309z M17.706,6.626c0.149-0.365,0.155-2.439-0.635-4.426c0,0-1.811,0.199-4.551,2.08c-0.575-0.16-1.548-0.238-2.519-0.238c-0.973,0-1.945,0.078-2.52,0.238C4.74,2.399,2.929,2.2,2.929,2.2C2.14,4.187,2.148,6.261,2.295,6.626C1.367,7.634,0.8,8.845,0.8,10.497c0,7.186,5.963,7.301,7.467,7.301c0.342,0,1.018,0.002,1.734,0.002c0.715,0,1.392-0.002,1.732-0.002c1.506,0,7.467-0.115,7.467-7.301C19.2,8.845,18.634,7.634,17.706,6.626z M10.028,16.915H9.972c-3.771,0-6.709-0.449-6.709-4.115c0-0.879,0.31-1.693,1.047-2.369c1.227-1.127,3.305-0.531,5.662-0.531c0.01,0,0.02,0,0.029,0c0.01,0,0.018,0,0.027,0c2.357,0,4.436-0.596,5.664,0.531c0.735,0.676,1.045,1.49,1.045,2.369C16.737,16.466,13.8,16.915,10.028,16.915z M6.821,11.309c-0.718,0-1.3,0.807-1.3,1.799c0,0.994,0.582,1.801,1.3,1.801c0.719,0,1.301-0.807,1.301-1.801C8.122,12.116,7.54,11.309,6.821,11.309z" fill="currentColor"></path>
              </svg>
              https://github.com/{entry.data.repo}{project.stars ? ` (${formatNumber(project.stars as number)})` : ''}
            </a>
          </div>
        )}
        {entry.data.twitter && (
          <div class="detail-link">
            <a href={`https://x.com/${entry.data.twitter}`} target="_blank" rel="noopener noreferrer">
              <svg class="icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" fill="currentColor"></path>
              </svg>
              @{entry.data.twitter}
            </a>
          </div>
        )}
      </div>

      <div class="site-generators">
        <span class="title">Supported Site Generators:</span>
        <span>{entry.data.supportedgenerators.join(', ')}</span>
      </div>

      {entry.data.images && entry.data.images.length > 0 && (
        <div class="images">
          {entry.data.images.map((image: { path: string }) => (
            <img src={image.path} alt={`${entry.data.title} screenshot`} class="responsive" />
          ))}
        </div>
      )}

      <div class="text">
        <Content />
      </div>
    </div>
  </div>
  <Footer />
</BaseLayout>
